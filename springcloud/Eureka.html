<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/springcloud/Eureka.html"><meta property="og:site_name" content="码农参上"><meta property="og:title" content="Eureka核心源码解析"><meta property="og:description" content="Eureka作为Spring Cloud的核心模块之一，担任着服务注册发现等重要作用。如果梳理一下Eureka实际的工作流程，大体可以将它分为以下几个部分： 服务注册; 服务续约; 服务剔除; 服务下线; 服务发现; 集群信息同步; 上述各个方面，基于服务的运行场景不同，可能分别从Eureka的服务端（注册中心）与客户端（包含服务提供者与服务调用者）进..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-04-03T05:56:54.000Z"><meta property="article:author" content="Hydra"><meta property="article:tag" content="Spring Cloud"><meta property="article:tag" content="Eureka"><meta property="article:published_time" content="2020-05-22T00:00:00.000Z"><meta property="article:modified_time" content="2023-04-03T05:56:54.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Eureka核心源码解析","image":[""],"datePublished":"2020-05-22T00:00:00.000Z","dateModified":"2023-04-03T05:56:54.000Z","author":[{"@type":"Person","name":"Hydra"}]}</script><title>Eureka核心源码解析 | 码农参上</title><meta name="description" content="Eureka作为Spring Cloud的核心模块之一，担任着服务注册发现等重要作用。如果梳理一下Eureka实际的工作流程，大体可以将它分为以下几个部分： 服务注册; 服务续约; 服务剔除; 服务下线; 服务发现; 集群信息同步; 上述各个方面，基于服务的运行场景不同，可能分别从Eureka的服务端（注册中心）与客户端（包含服务提供者与服务调用者）进...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-a0c387d4.css" as="style"><link rel="stylesheet" href="/assets/style-a0c387d4.css">
    <link rel="modulepreload" href="/assets/app-ef013678.js"><link rel="modulepreload" href="/assets/framework-9e67db09.js"><link rel="modulepreload" href="/assets/Eureka.html-9cb51a00.js"><link rel="modulepreload" href="/assets/Eureka.html-6e95f60c.js"><link rel="prefetch" href="/assets/index.html-c52d4514.js" as="script"><link rel="prefetch" href="/assets/aboutMe.html-f2d767ad.js" as="script"><link rel="prefetch" href="/assets/JDK15.html-e80cc6ca.js" as="script"><link rel="prefetch" href="/assets/JNI.html-9d6aaf79.js" as="script"><link rel="prefetch" href="/assets/JavaAgent.html-5cb144ea.js" as="script"><link rel="prefetch" href="/assets/Proxy.html-1215ffef.js" as="script"><link rel="prefetch" href="/assets/dynamicProxy.html-6db9ce2c.js" as="script"><link rel="prefetch" href="/assets/javaMemoryLayout.html-ab0fb9b3.js" as="script"><link rel="prefetch" href="/assets/unsafe.html-554e90b7.js" as="script"><link rel="prefetch" href="/assets/Neo4j.html-220120ba.js" as="script"><link rel="prefetch" href="/assets/bayes.html-c5b94c5c.js" as="script"><link rel="prefetch" href="/assets/knowledgeGraph.html-4c6c26f7.js" as="script"><link rel="prefetch" href="/assets/wenxin.html-ca73dc2c.js" as="script"><link rel="prefetch" href="/assets/ArrayBlockingQueue.html-47e4bf86.js" as="script"><link rel="prefetch" href="/assets/DelayQueue.html-bc395b13.js" as="script"><link rel="prefetch" href="/assets/LinkedBlockingQueue.html-2810a694.js" as="script"><link rel="prefetch" href="/assets/PriorityBlockingQueue.html-7bb0a114.js" as="script"><link rel="prefetch" href="/assets/SynchronousQueueFair.html-a350e98d.js" as="script"><link rel="prefetch" href="/assets/SynchronousQueueUnfair.html-2d0ab75e.js" as="script"><link rel="prefetch" href="/assets/gcAnimate.html-635f8666.js" as="script"><link rel="prefetch" href="/assets/OAuth2Code.html-bcbc29a5.js" as="script"><link rel="prefetch" href="/assets/ShiroJWT.html-2d672e85.js" as="script"><link rel="prefetch" href="/assets/tokenUse.html-0a5c8e6a.js" as="script"><link rel="prefetch" href="/assets/AQS.html-1691e707.js" as="script"><link rel="prefetch" href="/assets/CountDownLatchCyclicBarrier.html-34dacbfd.js" as="script"><link rel="prefetch" href="/assets/HashMap.html-191c8bf1.js" as="script"><link rel="prefetch" href="/assets/cas.html-7598d761.js" as="script"><link rel="prefetch" href="/assets/rateLimit.html-0da0adfc.js" as="script"><link rel="prefetch" href="/assets/requestMerge.html-ea1e598e.js" as="script"><link rel="prefetch" href="/assets/singleton.html-202ae451.js" as="script"><link rel="prefetch" href="/assets/synchronizedUp.html-a876d731.js" as="script"><link rel="prefetch" href="/assets/synchronizedvolatile.html-994d0058.js" as="script"><link rel="prefetch" href="/assets/WhyIHateFrameworks.html-863e8452.js" as="script"><link rel="prefetch" href="/assets/cannotUnderstand.html-33f67bb5.js" as="script"><link rel="prefetch" href="/assets/grandHistory.html-51514bad.js" as="script"><link rel="prefetch" href="/assets/mofish.html-426941ce.js" as="script"><link rel="prefetch" href="/assets/netren.html-d2ec58fd.js" as="script"><link rel="prefetch" href="/assets/qingdao.html-5041f501.js" as="script"><link rel="prefetch" href="/assets/traffickingAnxiety.html-b5011e4f.js" as="script"><link rel="prefetch" href="/assets/RedisAcid.html-87f51b49.js" as="script"><link rel="prefetch" href="/assets/StringLowLevel.html-eb67864e.js" as="script"><link rel="prefetch" href="/assets/deserialization.html-a3e30cab.js" as="script"><link rel="prefetch" href="/assets/forCircle.html-6db0ef6f.js" as="script"><link rel="prefetch" href="/assets/genericType.html-b0b2cf83.js" as="script"><link rel="prefetch" href="/assets/stringappend.html-a8acf53b.js" as="script"><link rel="prefetch" href="/assets/MyBatisExt.html-6bd9ab17.js" as="script"><link rel="prefetch" href="/assets/executeProcess.html-2ca8ee29.js" as="script"><link rel="prefetch" href="/assets/interceptor.html-aeaee6eb.js" as="script"><link rel="prefetch" href="/assets/join.html-9c84e8ef.js" as="script"><link rel="prefetch" href="/assets/multiTenancy.html-383569a3.js" as="script"><link rel="prefetch" href="/assets/multiTenancyAdvanced.html-9e9129c7.js" as="script"><link rel="prefetch" href="/assets/BatchSqlOptimize.html-5741a370.js" as="script"><link rel="prefetch" href="/assets/MysqlBinlogJava.html-23534163.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere.html-e49519db.js" as="script"><link rel="prefetch" href="/assets/hideColumns.html-8c07dac3.js" as="script"><link rel="prefetch" href="/assets/rmrf.html-cf8eced2.js" as="script"><link rel="prefetch" href="/assets/transaction.html-75dcd152.js" as="script"><link rel="prefetch" href="/assets/BeanCopy.html-2e2cf9c4.js" as="script"><link rel="prefetch" href="/assets/ConfigurationCenter.html-28b210fc.js" as="script"><link rel="prefetch" href="/assets/DockerMining.html-def65b36.js" as="script"><link rel="prefetch" href="/assets/GuavaMap.html-d3e8e15b.js" as="script"><link rel="prefetch" href="/assets/HystrixRateLimite.html-95aad7ba.js" as="script"><link rel="prefetch" href="/assets/JavaQuasar.html-3e675278.js" as="script"><link rel="prefetch" href="/assets/NettyChat.html-6aad83cb.js" as="script"><link rel="prefetch" href="/assets/NettyRPC.html-afa37360.js" as="script"><link rel="prefetch" href="/assets/Postman.html-ed367a85.js" as="script"><link rel="prefetch" href="/assets/XxlJobModify.html-76f9df17.js" as="script"><link rel="prefetch" href="/assets/ZookeeperDistributedLock.html-4bd53f05.js" as="script"><link rel="prefetch" href="/assets/Cluster.html-c1d3bf40.js" as="script"><link rel="prefetch" href="/assets/RESP2.html-30d553c4.js" as="script"><link rel="prefetch" href="/assets/RESP3.html-34eb690d.js" as="script"><link rel="prefetch" href="/assets/Redis6ClientSideCache.html-831eee74.js" as="script"><link rel="prefetch" href="/assets/RedisPlusCaffeine.html-5d210b73.js" as="script"><link rel="prefetch" href="/assets/RedissonCloseOrder.html-1b1ca041.js" as="script"><link rel="prefetch" href="/assets/SpringImplementCaffeinePlusRedis.html-c8f9eda3.js" as="script"><link rel="prefetch" href="/assets/WindowsCompileRedis.html-d189d724.js" as="script"><link rel="prefetch" href="/assets/clientSideCaching.html-85e3f924.js" as="script"><link rel="prefetch" href="/assets/distribute.html-e662284f.js" as="script"><link rel="prefetch" href="/assets/extendDataType.html-a09a3d91.js" as="script"><link rel="prefetch" href="/assets/guard.html-78c7be3f.js" as="script"><link rel="prefetch" href="/assets/mastersSlave.html-842cf22d.js" as="script"><link rel="prefetch" href="/assets/threePro.html-98b97b9e.js" as="script"><link rel="prefetch" href="/assets/InitializateBean.html-60a847db.js" as="script"><link rel="prefetch" href="/assets/SpringBootYmlParse.html-f87235b6.js" as="script"><link rel="prefetch" href="/assets/circleDependency.html-4d2c9caf.js" as="script"><link rel="prefetch" href="/assets/collectAutowired.html-bdc1a2c3.js" as="script"><link rel="prefetch" href="/assets/containerInit.html-014680d0.js" as="script"><link rel="prefetch" href="/assets/processor.html-930d1d34.js" as="script"><link rel="prefetch" href="/assets/ymlRead.html-93805451.js" as="script"><link rel="prefetch" href="/assets/zeroConfig.html-8d28de44.js" as="script"><link rel="prefetch" href="/assets/Feign.html-dacac695.js" as="script"><link rel="prefetch" href="/assets/Ribbon.html-f67875a7.js" as="script"><link rel="prefetch" href="/assets/Seata.html-06851c81.js" as="script"><link rel="prefetch" href="/assets/SeataTCC.html-bbfe34e6.js" as="script"><link rel="prefetch" href="/assets/SentinelRulePersistence.html-2033b523.js" as="script"><link rel="prefetch" href="/assets/SentinelUse.html-b59cd530.js" as="script"><link rel="prefetch" href="/assets/feignEnhancer.html-b512f27c.js" as="script"><link rel="prefetch" href="/assets/tokenOptimize.html-b4725a41.js" as="script"><link rel="prefetch" href="/assets/authLogin.html-6404e742.js" as="script"><link rel="prefetch" href="/assets/payment.html-bd666e49.js" as="script"><link rel="prefetch" href="/assets/refund.html-0d3cbf88.js" as="script"><link rel="prefetch" href="/assets/404.html-570934d7.js" as="script"><link rel="prefetch" href="/assets/index.html-880a87ac.js" as="script"><link rel="prefetch" href="/assets/index.html-530bda9a.js" as="script"><link rel="prefetch" href="/assets/index.html-c53b7f02.js" as="script"><link rel="prefetch" href="/assets/index.html-0954684a.js" as="script"><link rel="prefetch" href="/assets/index.html-1c7040c3.js" as="script"><link rel="prefetch" href="/assets/index.html-b2ee7e8f.js" as="script"><link rel="prefetch" href="/assets/index.html-b23605fc.js" as="script"><link rel="prefetch" href="/assets/index.html-ab0dd751.js" as="script"><link rel="prefetch" href="/assets/index.html-17cd0bce.js" as="script"><link rel="prefetch" href="/assets/index.html-5b58eb0b.js" as="script"><link rel="prefetch" href="/assets/index.html-73fea25d.js" as="script"><link rel="prefetch" href="/assets/index.html-b56d372b.js" as="script"><link rel="prefetch" href="/assets/index.html-31c2d841.js" as="script"><link rel="prefetch" href="/assets/index.html-8bcfaf59.js" as="script"><link rel="prefetch" href="/assets/index.html-b333b4e2.js" as="script"><link rel="prefetch" href="/assets/aboutMe.html-a4e40d1a.js" as="script"><link rel="prefetch" href="/assets/JDK15.html-6652af88.js" as="script"><link rel="prefetch" href="/assets/JNI.html-c75fe16e.js" as="script"><link rel="prefetch" href="/assets/JavaAgent.html-9f9eab57.js" as="script"><link rel="prefetch" href="/assets/Proxy.html-0e3db8cd.js" as="script"><link rel="prefetch" href="/assets/dynamicProxy.html-1a1dc17b.js" as="script"><link rel="prefetch" href="/assets/javaMemoryLayout.html-6c5f45e8.js" as="script"><link rel="prefetch" href="/assets/unsafe.html-a00c51b0.js" as="script"><link rel="prefetch" href="/assets/Neo4j.html-1cda5c93.js" as="script"><link rel="prefetch" href="/assets/bayes.html-bd5636c9.js" as="script"><link rel="prefetch" href="/assets/knowledgeGraph.html-68f796a8.js" as="script"><link rel="prefetch" href="/assets/wenxin.html-e656ae03.js" as="script"><link rel="prefetch" href="/assets/ArrayBlockingQueue.html-de74e73b.js" as="script"><link rel="prefetch" href="/assets/DelayQueue.html-a0bc801f.js" as="script"><link rel="prefetch" href="/assets/LinkedBlockingQueue.html-306c06f0.js" as="script"><link rel="prefetch" href="/assets/PriorityBlockingQueue.html-e9d25178.js" as="script"><link rel="prefetch" href="/assets/SynchronousQueueFair.html-ff0d26c0.js" as="script"><link rel="prefetch" href="/assets/SynchronousQueueUnfair.html-1300fd4b.js" as="script"><link rel="prefetch" href="/assets/gcAnimate.html-90362a7c.js" as="script"><link rel="prefetch" href="/assets/OAuth2Code.html-ced60c1f.js" as="script"><link rel="prefetch" href="/assets/ShiroJWT.html-99c8cd97.js" as="script"><link rel="prefetch" href="/assets/tokenUse.html-fb9e89c5.js" as="script"><link rel="prefetch" href="/assets/AQS.html-5fdfa651.js" as="script"><link rel="prefetch" href="/assets/CountDownLatchCyclicBarrier.html-bed56b1e.js" as="script"><link rel="prefetch" href="/assets/HashMap.html-d610cc00.js" as="script"><link rel="prefetch" href="/assets/cas.html-d6dfecf6.js" as="script"><link rel="prefetch" href="/assets/rateLimit.html-3b670f93.js" as="script"><link rel="prefetch" href="/assets/requestMerge.html-82cf201a.js" as="script"><link rel="prefetch" href="/assets/singleton.html-cf4c08d0.js" as="script"><link rel="prefetch" href="/assets/synchronizedUp.html-d224e372.js" as="script"><link rel="prefetch" href="/assets/synchronizedvolatile.html-eb96ee32.js" as="script"><link rel="prefetch" href="/assets/WhyIHateFrameworks.html-0fa5854a.js" as="script"><link rel="prefetch" href="/assets/cannotUnderstand.html-1ff295cc.js" as="script"><link rel="prefetch" href="/assets/grandHistory.html-f6a158e3.js" as="script"><link rel="prefetch" href="/assets/mofish.html-a13d71b3.js" as="script"><link rel="prefetch" href="/assets/netren.html-5a044ef1.js" as="script"><link rel="prefetch" href="/assets/qingdao.html-d7e303e4.js" as="script"><link rel="prefetch" href="/assets/traffickingAnxiety.html-e48d5ad0.js" as="script"><link rel="prefetch" href="/assets/RedisAcid.html-378cb45a.js" as="script"><link rel="prefetch" href="/assets/StringLowLevel.html-03e3e440.js" as="script"><link rel="prefetch" href="/assets/deserialization.html-7d173abc.js" as="script"><link rel="prefetch" href="/assets/forCircle.html-a47b5d36.js" as="script"><link rel="prefetch" href="/assets/genericType.html-b7fac234.js" as="script"><link rel="prefetch" href="/assets/stringappend.html-ac1fde13.js" as="script"><link rel="prefetch" href="/assets/MyBatisExt.html-3c8dd628.js" as="script"><link rel="prefetch" href="/assets/executeProcess.html-c20ae117.js" as="script"><link rel="prefetch" href="/assets/interceptor.html-cfec9e59.js" as="script"><link rel="prefetch" href="/assets/join.html-50d44b63.js" as="script"><link rel="prefetch" href="/assets/multiTenancy.html-02512cbe.js" as="script"><link rel="prefetch" href="/assets/multiTenancyAdvanced.html-5bbf463d.js" as="script"><link rel="prefetch" href="/assets/BatchSqlOptimize.html-5d853304.js" as="script"><link rel="prefetch" href="/assets/MysqlBinlogJava.html-03c38ea3.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere.html-52b251b9.js" as="script"><link rel="prefetch" href="/assets/hideColumns.html-10d0455b.js" as="script"><link rel="prefetch" href="/assets/rmrf.html-c9853a85.js" as="script"><link rel="prefetch" href="/assets/transaction.html-97f28403.js" as="script"><link rel="prefetch" href="/assets/BeanCopy.html-dd3c89c1.js" as="script"><link rel="prefetch" href="/assets/ConfigurationCenter.html-42676ad8.js" as="script"><link rel="prefetch" href="/assets/DockerMining.html-f05b9e76.js" as="script"><link rel="prefetch" href="/assets/GuavaMap.html-4ec4501c.js" as="script"><link rel="prefetch" href="/assets/HystrixRateLimite.html-0d9e647a.js" as="script"><link rel="prefetch" href="/assets/JavaQuasar.html-d71479e0.js" as="script"><link rel="prefetch" href="/assets/NettyChat.html-2c7f987a.js" as="script"><link rel="prefetch" href="/assets/NettyRPC.html-4cc02bfa.js" as="script"><link rel="prefetch" href="/assets/Postman.html-c3e32b02.js" as="script"><link rel="prefetch" href="/assets/XxlJobModify.html-15b01d63.js" as="script"><link rel="prefetch" href="/assets/ZookeeperDistributedLock.html-bee0c40c.js" as="script"><link rel="prefetch" href="/assets/Cluster.html-8bd04a0e.js" as="script"><link rel="prefetch" href="/assets/RESP2.html-cc8ab89b.js" as="script"><link rel="prefetch" href="/assets/RESP3.html-07bab260.js" as="script"><link rel="prefetch" href="/assets/Redis6ClientSideCache.html-5c9024cc.js" as="script"><link rel="prefetch" href="/assets/RedisPlusCaffeine.html-d2fe8f5d.js" as="script"><link rel="prefetch" href="/assets/RedissonCloseOrder.html-c4294d8c.js" as="script"><link rel="prefetch" href="/assets/SpringImplementCaffeinePlusRedis.html-c62f93c0.js" as="script"><link rel="prefetch" href="/assets/WindowsCompileRedis.html-308f8173.js" as="script"><link rel="prefetch" href="/assets/clientSideCaching.html-26b9f66f.js" as="script"><link rel="prefetch" href="/assets/distribute.html-ec666c2e.js" as="script"><link rel="prefetch" href="/assets/extendDataType.html-0b0fc73c.js" as="script"><link rel="prefetch" href="/assets/guard.html-18f30789.js" as="script"><link rel="prefetch" href="/assets/mastersSlave.html-787518d3.js" as="script"><link rel="prefetch" href="/assets/threePro.html-d9c3cb1b.js" as="script"><link rel="prefetch" href="/assets/InitializateBean.html-425f6b22.js" as="script"><link rel="prefetch" href="/assets/SpringBootYmlParse.html-5ec7004e.js" as="script"><link rel="prefetch" href="/assets/circleDependency.html-00bd5113.js" as="script"><link rel="prefetch" href="/assets/collectAutowired.html-06deda2c.js" as="script"><link rel="prefetch" href="/assets/containerInit.html-e1611682.js" as="script"><link rel="prefetch" href="/assets/processor.html-70d92739.js" as="script"><link rel="prefetch" href="/assets/ymlRead.html-e96529f9.js" as="script"><link rel="prefetch" href="/assets/zeroConfig.html-9b4b69e9.js" as="script"><link rel="prefetch" href="/assets/Feign.html-b7921857.js" as="script"><link rel="prefetch" href="/assets/Ribbon.html-843b0937.js" as="script"><link rel="prefetch" href="/assets/Seata.html-8c69b308.js" as="script"><link rel="prefetch" href="/assets/SeataTCC.html-419525f0.js" as="script"><link rel="prefetch" href="/assets/SentinelRulePersistence.html-7a1d8115.js" as="script"><link rel="prefetch" href="/assets/SentinelUse.html-153b33c8.js" as="script"><link rel="prefetch" href="/assets/feignEnhancer.html-f26e2119.js" as="script"><link rel="prefetch" href="/assets/tokenOptimize.html-e73f8eaa.js" as="script"><link rel="prefetch" href="/assets/authLogin.html-6a17374b.js" as="script"><link rel="prefetch" href="/assets/payment.html-5801e14d.js" as="script"><link rel="prefetch" href="/assets/refund.html-422629af.js" as="script"><link rel="prefetch" href="/assets/404.html-7eab5a9a.js" as="script"><link rel="prefetch" href="/assets/index.html-3da72fa3.js" as="script"><link rel="prefetch" href="/assets/index.html-cb444a2f.js" as="script"><link rel="prefetch" href="/assets/index.html-876ec228.js" as="script"><link rel="prefetch" href="/assets/index.html-8809f2d1.js" as="script"><link rel="prefetch" href="/assets/index.html-8a530847.js" as="script"><link rel="prefetch" href="/assets/index.html-f485fa23.js" as="script"><link rel="prefetch" href="/assets/index.html-c2482399.js" as="script"><link rel="prefetch" href="/assets/index.html-f7f05922.js" as="script"><link rel="prefetch" href="/assets/index.html-e672dad0.js" as="script"><link rel="prefetch" href="/assets/index.html-b2f19ae8.js" as="script"><link rel="prefetch" href="/assets/index.html-2e65b017.js" as="script"><link rel="prefetch" href="/assets/index.html-cd91088a.js" as="script"><link rel="prefetch" href="/assets/index.html-d58cbf6e.js" as="script"><link rel="prefetch" href="/assets/index.html-711ee22a.js" as="script"><link rel="prefetch" href="/assets/auto-ba5ecab5.js" as="script"><link rel="prefetch" href="/assets/index-b03bef79.js" as="script"><link rel="prefetch" href="/assets/flowchart-35969cab.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-b3ed263f.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-a794bb63.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-d92a2fc9.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-224f94d9.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-e5069ce0.js" as="script"><link rel="prefetch" href="/assets/search.esm-2c3fba7d.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-59b0b449.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-6e6cbe40.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo64.jpg" alt="码农参上"><!----><span class="site-name hide-in-pad">码农参上</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="首页"><span class="font-icon icon iconfont icon-home" style=""></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/spring/containerInit.html/" class="nav-link" aria-label="文章"><span class="font-icon icon iconfont icon-discover" style=""></span>文章<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/trunks2008" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-leaf" style=""></span><span class="title">Spring</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-workingDirectory" style=""></span><span class="title">Redis</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-animation" style=""></span><span class="title">动图图解</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-asynchronous" style=""></span><span class="title">并发编程</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-discover" style=""></span><span class="title">Spring Cloud</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/springcloud/Eureka.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Eureka核心源码解析"><span class="font-icon icon iconfont icon-page" style=""></span>Eureka核心源码解析<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#服务注册" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="服务注册"><!---->服务注册<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-client"><!---->Eureka-client<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-server"><!---->Eureka-server<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#服务续约" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="服务续约"><!---->服务续约<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-client"><!---->Eureka-client<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-server"><!---->Eureka-server<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#服务剔除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="服务剔除"><!---->服务剔除<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-server"><!---->Eureka-server<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#服务下线" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="服务下线"><!---->服务下线<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client-2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-client"><!---->Eureka-client<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-3" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-server"><!---->Eureka-server<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#服务发现" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="服务发现"><!---->服务发现<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client-3" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-client"><!---->Eureka-client<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#集群信息同步" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="集群信息同步"><!---->集群信息同步<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-4" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Eureka-server"><!---->Eureka-server<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/springcloud/Eureka.html#最后" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="最后"><!---->最后<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/springcloud/Ribbon.html" class="nav-link sidebar-link sidebar-page" aria-label="Ribbon核心源码解析"><span class="font-icon icon iconfont icon-page" style=""></span>Ribbon核心源码解析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/Feign.html" class="nav-link sidebar-link sidebar-page" aria-label="Feign核心源码解析"><span class="font-icon icon iconfont icon-page" style=""></span>Feign核心源码解析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/SentinelUse.html" class="nav-link sidebar-link sidebar-page" aria-label="Sentinel使用及规则配置"><span class="font-icon icon iconfont icon-page" style=""></span>Sentinel使用及规则配置<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/SentinelRulePersistence.html" class="nav-link sidebar-link sidebar-page" aria-label="SpringCloud Alibaba Sentinel规则持久化"><span class="font-icon icon iconfont icon-page" style=""></span>SpringCloud Alibaba Sentinel规则持久化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/Seata.html" class="nav-link sidebar-link sidebar-page" aria-label="Seata搭建与分布式事务入门"><span class="font-icon icon iconfont icon-page" style=""></span>Seata搭建与分布式事务入门<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/SeataTCC.html" class="nav-link sidebar-link sidebar-page" aria-label="Seata TCC模式原理与实战"><span class="font-icon icon iconfont icon-page" style=""></span>Seata TCC模式原理与实战<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/tokenOptimize.html" class="nav-link sidebar-link sidebar-page" aria-label="微服务中，如何优化接口调用"><span class="font-icon icon iconfont icon-page" style=""></span>微服务中，如何优化接口调用<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/springcloud/feignEnhancer.html" class="nav-link sidebar-link sidebar-page" aria-label="简化本地Feign调用，老手教你这么玩"><span class="font-icon icon iconfont icon-page" style=""></span>简化本地Feign调用，老手教你这么玩<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-java" style=""></span><span class="title">Java进阶</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-mysql" style=""></span><span class="title">MySql</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-grid" style=""></span><span class="title">MyBatis</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-profile" style=""></span><span class="title">面试扩展</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-creative" style=""></span><span class="title">项目实战</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-anonymous" style=""></span><span class="title">认证鉴权</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-emmet" style=""></span><span class="title">机器学习</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-emoji" style=""></span><span class="title">荒腔走板</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-wechat" style=""></span><span class="title">微信开发</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-page" style=""></span>Eureka核心源码解析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Hydra</span></span><span property="author" content="Hydra"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2020-05-22T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 13 分钟</span><meta property="timeRequired" content="PT13M"></span><!----><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag8" role>Spring Cloud</span><span class="page-tag-item tag3" role>Eureka</span><meta property="keywords" content="Spring Cloud,Eureka"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#服务注册" class="router-link-active router-link-exact-active toc-link level2">服务注册</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client" class="router-link-active router-link-exact-active toc-link level3">Eureka-client</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server" class="router-link-active router-link-exact-active toc-link level3">Eureka-server</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#服务续约" class="router-link-active router-link-exact-active toc-link level2">服务续约</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client-1" class="router-link-active router-link-exact-active toc-link level3">Eureka-client</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-1" class="router-link-active router-link-exact-active toc-link level3">Eureka-server</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#服务剔除" class="router-link-active router-link-exact-active toc-link level2">服务剔除</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-2" class="router-link-active router-link-exact-active toc-link level3">Eureka-server</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#服务下线" class="router-link-active router-link-exact-active toc-link level2">服务下线</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client-2" class="router-link-active router-link-exact-active toc-link level3">Eureka-client</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-3" class="router-link-active router-link-exact-active toc-link level3">Eureka-server</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#服务发现" class="router-link-active router-link-exact-active toc-link level2">服务发现</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-client-3" class="router-link-active router-link-exact-active toc-link level3">Eureka-client</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#集群信息同步" class="router-link-active router-link-exact-active toc-link level2">集群信息同步</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#eureka-server-4" class="router-link-active router-link-exact-active toc-link level3">Eureka-server</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/springcloud/Eureka.html#最后" class="router-link-active router-link-exact-active toc-link level2">最后</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><!-- more --><p>Eureka作为Spring Cloud的核心模块之一，担任着服务注册发现等重要作用。如果梳理一下Eureka实际的工作流程，大体可以将它分为以下几个部分：</p><ul><li>服务注册</li><li>服务续约</li><li>服务剔除</li><li>服务下线</li><li>服务发现</li><li>集群信息同步</li></ul><p>上述各个方面，基于服务的运行场景不同，可能分别从Eureka的服务端（注册中心）与客户端（包含服务提供者与服务调用者）进行分析，为了简便下文中将Eureka服务端称为Eureka-server，客户端称为Eureka-client。本文先来说说基础的服务注册。</p><h2 id="服务注册" tabindex="-1"><a class="header-anchor" href="#服务注册" aria-hidden="true">#</a> 服务注册</h2><h3 id="eureka-client" tabindex="-1"><a class="header-anchor" href="#eureka-client" aria-hidden="true">#</a> Eureka-client</h3><p>在Eureka-client中，DiscoveryClient这个类用来和Eureka-server互相协作，看一下它的注释，它可以完成服务注册，服务续约，服务下线，获取服务列表等工作，可以说它完成了client的大多数功能。首先，看一下用来向eureka-server发起注册请求的<code>register</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bef24ee0178847d3b9e756887c7e2c0c~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>调用 <code>AbstractJerseyEurekaHttpClient</code> 类的<code>register</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb02bc7e8ae6483da59486cbd1b4120a~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>Jersey是一个Restful请求服务的框架，与常用的springmvc类似，后面会讲到在Eureka-server拦截请求的时候也用到了Jersy。</p><p>在这里调用底层类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jersey<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>Client</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>通过HTTP客户端发送http请求，并构建响应结果。</p><h3 id="eureka-server" tabindex="-1"><a class="header-anchor" href="#eureka-server" aria-hidden="true">#</a> Eureka-server</h3><p>在Eureka-server，配置好<code>yml</code>文件中必需的参数后，只需要一个注解开启：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableEurekaServer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看该注解的实现方法，发现为空白注解，并使用了<code>@Import</code>：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerMarkerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看<code>EurekaServerMarkerConfiguration</code>类的实现：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9219eac2b58f4e639b2ad3a68182c680~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在这里只向spring容器中注入bean，没有任何意义。这里用到了Springboot的自动装配（这个不熟悉的可以参考<a href="https://juejin.cn/post/7019224268000985125" target="_blank" rel="noopener noreferrer">springboot零配置启动<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97da9b63cb3647ae9427ea5cf4b59afd~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>发现Eureka server核心的自动配置类<code>EurekaServerAutoConfiguration</code></p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1540e0e8644745b7bbfd470a0306b1f6~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>我们看到，在这个类上有条件注入注解：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerMarkerConfiguration<span class="token punctuation">.</span>Marker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>只有在Spring容器中存在Marker这个Bean时才会实例化这个类，所以<code>@EnableEurekaServer</code>就相当于一个开关，起到标识的作用。</p><p>在这个配置类中定义了拦截器，同样使用Jersy拦截请求：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56fde61e89864bf8a16324c9d8b9b589~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p><code>ApplicationResource</code>类的<code>addInstance</code>方法接收请求，在对实例的信息进行验证后，向服务注册中心添加实例：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/133f5feb2f604c0094288ddf2962ff6c~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>进入<code>InstanceRegistry</code>的<code>register</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7960d469b3124cdab23471221fe86f2b~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在这里做了两个功能：</p><p>1、调用<code>handleRegistration</code>，在方法中使用<code>publishEvent</code>发布了监听事件 。Spring支持事件驱动，可以监听者模式进行事件的监听，这里广播给所有监听者，收到一个服务注册的请求。</p><p>至于监听器，可以由我们自己手写实现，参数中的事件类型spring会帮我们直接注入：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaRegisterListener</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@EventListener</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registe</span><span class="token punctuation">(</span><span class="token class-name">EurekaInstanceRegisteredEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getInstanceInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、调用父类<code>PeerAwareInstanceRegistryImpl</code>的<code>register</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8bfa88da400419ca69909d43a04a6ff~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>进行了下面的操作：</p><p>① 拿到微服务的过期时间，并进行更新</p><p>② 将服务注册交给父类完成</p><p>③ 完成集群信息同步（这个会在后面说明）</p><p>调用父类<code>AbstractInstanceRegistry</code>的<code>register</code>方法，在这开始真正开始做服务注册。先说一下在这个类中定义的Eureka-server的服务注册列表的结构：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> registry<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>ConcurrentHashMap</code>中外层的String表示服务名称；</p><p><code>Map</code>中的String表示服务节点的id （也就是实例的instanceid）；</p><p><code>Lease</code>是一个心跳续约的对象，<code>InstanceInfo</code>表示实例信息。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39ba660a4c06482a94c0a565326c286e~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>首先，注册表根据微服务的名称或取Map，如果不存在就新建，使用<code>putIfAbsent</code>。</p><p>然后，从<code>gMap</code>（gMap就是该服务的实例列表）获取一次服务实例，判断这个微服务的节点是否存在，第一次注册的情况下一般是不存在的</p><p>当然，也有可能会发生注册信息冲突时，这时Eureka会根据最后活跃时间来判断到底覆盖哪一个：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/549c0c8f804b47479b872dc6ab00466c~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>这段代码中，Eureka拿到存在节点的最后活跃时间，和当前注册节点的发起注册时间，进行对比。当存在的节点的最后活跃时间大于当前注册节点的时间，就说明之前存在的节点更活跃，就替换当前节点。</p><p>这里有一个思想，就是如果Eureka缓存的老节点更活跃，就说明它能够使用，而新来的服务我并不知道是否能用，那么Eureka就保守的使用了可用的老节点，从这一点也保证了可用性</p><p>在拿到服务实例后对其进行封装：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16ec9d7500bc4d1ea46767b73fef4dc0~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>Lease是一个心跳续约的包装类，里面存放了注册信息，最后操作时间，注册时间，过期时间，剔除时间等信息。在这里把注册实例及过期时间放到这个心跳续约对象中，再把心跳续约对象放到<code>gmap</code>注册表中去。之后进行改变服务状态，系统数据统计，至此一个服务注册的流程就完成了。</p><p>注册完成后，查看一下<code>registry</code>中的服务实例，发现我们启动的Eureka-client都已经放在里面了：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff19e924d4454721a0dcbc0a4509c29a~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><h2 id="服务续约" tabindex="-1"><a class="header-anchor" href="#服务续约" aria-hidden="true">#</a> 服务续约</h2><h3 id="eureka-client-1" tabindex="-1"><a class="header-anchor" href="#eureka-client-1" aria-hidden="true">#</a> Eureka-client</h3><p>服务续约由Eureka-client端主动发起，由之前介绍过的<code>DiscoveryClient</code>类中的<code>renew</code>方法完成，主要内容仍然是发送http请求：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ece9779e250e44c68f553ba22fa14e92~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>每隔30秒进行一次续约,调用<code>AbstractJerseyEurekaHttpClient</code>的<code>sendHeartBeat</code>方法:</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac22625742fc4fcaa1ec9e001eb174e5~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><h3 id="eureka-server-1" tabindex="-1"><a class="header-anchor" href="#eureka-server-1" aria-hidden="true">#</a> Eureka-server</h3><p>在Eureka-server端，服务续约的调用链与服务注册基本相同：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">InstanceRegistry</span> # <span class="token function">renew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
<span class="token class-name">PeerAwareInstanceRegistry</span> # <span class="token function">renew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>
<span class="token class-name">AbstractInstanceRegistry</span> # <span class="token function">renew</span><span class="token punctuation">(</span><span class="token punctuation">)</span>v
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要看一下<code>AbstractInstanceRegistry</code> 的<code>renew</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab5fa4301f894d1382e617cb1c8863a0~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>先从注册表获取该服务的实例列表gMap，再从gMap中通过实例的id 获取具体的 要续约的实例。之后根据服务实例的<code>InstanceStatus</code>判断是否处于宕机状态，以及是否和之前状态相同。如果一切状态正常，最终调用<code>Lease</code>中的<code>renew</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b94cad4e00fa4ba4ad696a865bb06fe2~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>可以看出，其实服务续约的操作非常简单，它的本质就是修改服务的最后的更新时间。将最后更新时间改为系统当前时间加上服务的过期时间。值得提一下的是，<code>lastUpdateTimestamp</code>这个变量是被<code>volatile</code>关键字修饰的。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/758d4b3e74724a759f8df05013a3c382~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>之前的文章中我们讲过<code>volitaile</code>是用来保证可见性的。那么要被谁可见呢，提前说一下，这里要被服务剔除中执行的定时任务可见，后面会具体分析。</p><h2 id="服务剔除" tabindex="-1"><a class="header-anchor" href="#服务剔除" aria-hidden="true">#</a> 服务剔除</h2><h3 id="eureka-server-2" tabindex="-1"><a class="header-anchor" href="#eureka-server-2" aria-hidden="true">#</a> Eureka-server</h3><p>当Eureka-server发现有的实例没有续约超过一定时间，则将该服务从注册列表剔除，该项工作由一个定时任务完成的。该任务的定义过程比较复杂，仅列出其调用过程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">EurekaServerInitializerConfiguration</span> # <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
<span class="token class-name">EurekaServerBootstrap</span> # <span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                      # <span class="token function">initEurekaServerContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
<span class="token class-name">PeerAwareInstanceRegistryImpl</span> # <span class="token function">openForTraffic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
<span class="token class-name">AbstractInstanceRegistry</span> # <span class="token function">postInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1181721c1b634e0cb236fa3f0c093293~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在<code>AbstractInstanceRegistry</code>的<code>postInit</code>方法中，定义<code>EvictionTask</code>定时任务，构建定时器启动该任务，执行任务中剔除方法 <code>evict()</code>。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">long</span> evictionIntervalTimerInMs <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>任务的时间被定义为60秒，即默认每分钟执行一次。具体查看<code>evit()</code>剔除方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c2ef8efa38248e5a6de2732200b0ef9~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>实现了功能：</p><p>1、新建实例列表<code>expiredLeases</code>，用来存放过期的实</p><p>2、遍历<code>registry</code>注册表，对实例进行检测工作，使用<code>isExpired</code>方法判断实例是否过期：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8945595678654e05ba52a0e504e0195a~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>解释一下各个参数的意义：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>evictionTimestamp：剔除时间，当剔除节点的时候，将系统当前时间赋值给这个evictionTimestamp
additionalLeaseMs：集群同步产生的预留时间，这个时间是程序中传过来的
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里进行判断：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>系统当前时间 &gt; 最后更新时间 + 过期时间 + 预留时间
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当该条件成立时，认为服务过期。在Eureka中过期时间默认定义为3个心跳的时间，一个心跳是30秒，因此过期时间是90秒。当该条件成立时，认为服务过期。在Eureka中过期时间默认定义为3个心跳的时间，一个心跳是30秒，因此过期时间是90秒</p><p>当以上两个条件之一成立时，判断该实例过期，将该过期实例放入上面创建的列表中。注意这里仅仅是将实例放入List中，并没有实际剔除。</p><p>在实际剔除任务前，需要提一下eureka的自我保护机制，当15分钟内，心跳失败的服务大于一定比例时，会触发自我保护机制。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d540b97aaf346df90aeb60a3bf44379~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>这个值在Eureka中被定义为85%，一旦触发自我保护机制，Eureka会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bcea09d256f747fe8169b2a6ac6d0ee4~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>参数意义：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>registrySizeThreshold：根据阈值计算可以被剔除的服务数量最大值
evictionLimit：剔除后剩余最小数量
expiredLeases.size()：剔除列表的数量
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码中根据自我保护机制进行了判断，使用Min函数计算两者的最小值，剔除较小数量的服务实例。</p><p>举个例子，假如当前共有100个服务，那么剔除阈值为85，如果list中有60个服务，那么就会剔除该60个服务。但是如果list中有95个服务，那么只会剔除其中的85个服务，在这种情况下，又会产生一个问题，eureka-server该如何判断去剔除哪些服务，保留哪些服务呢？</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82c4bc17954042b4a02f23c6ee672c4e~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>这里使用了随机算法进行剔除，保证不会连续剔除某个微服务的全部实例。最终调用<code>internalCancel</code>方法，实际执行剔除。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b78ead27ee14babb1cd6fca36e6853c~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>其实剔除操作的实质非常简单，就是从<code>gMap</code>中<code>remove</code>掉这个节点，并从缓存中剔除。</p><h2 id="服务下线" tabindex="-1"><a class="header-anchor" href="#服务下线" aria-hidden="true">#</a> 服务下线</h2><h3 id="eureka-client-2" tabindex="-1"><a class="header-anchor" href="#eureka-client-2" aria-hidden="true">#</a> Eureka-client</h3><p>当eureka-client关闭时，不会立刻关闭，需要先发请求给eureka-server，告知自己要下线了。主要看一下客户端<code>shutdown</code>方法，其中调用关键的<code>unregister</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef554c934baa48b6b936e5bbeeb69545~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>调用<code>AbstractJerseyEurekaHttpClient</code> 的<code>cancel</code>方法</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df6638efe40047b9ae1dbfbd653d1455~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>发送http请求告诉eureka-server自己下线。</p><h3 id="eureka-server-3" tabindex="-1"><a class="header-anchor" href="#eureka-server-3" aria-hidden="true">#</a> Eureka-server</h3><p>调用<code>AbstractInstanceRegistry</code>中 <code>cancel</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7ed07f187784a8ea6bfdcbd58784964~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>最终还是调用了和服务剔除中一样的方法，<code>remove</code>掉了<code>gMap</code>中的实例。</p><h2 id="服务发现" tabindex="-1"><a class="header-anchor" href="#服务发现" aria-hidden="true">#</a> 服务发现</h2><h3 id="eureka-client-3" tabindex="-1"><a class="header-anchor" href="#eureka-client-3" aria-hidden="true">#</a> Eureka-client</h3><p>在学习服务发现的源码前，先写一个测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/find&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用<code>DiscoveryClient</code> 的<code>getInstances</code>方法，可以根据服务id获取服务实例列表：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/939f50bd7c01456ca938250645b1bd2b~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>那么这里就有一个问题了，我们还没有去调用微服务，那么服务列表是什么时候被拉取或缓存到本地的服务列表的呢？答案是在这里调用了<code>CompositeDiscoveryClient</code> 的 <code>getInstances()</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd266ca62a4f481eb7eba6ba7abdde9f~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>中间调用过程省略：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">EurekaDiscoveryClient</span> # <span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
<span class="token class-name">DiscoveryClient</span> # <span class="token function">getInstancesByVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                # <span class="token function">getInstancesByVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>  <span class="token comment">//和上面不是一个方法</span>
<span class="token class-name">Applications</span> # <span class="token function">getInstancesByVirtualHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看<code>Applications</code>中的<code>getInstancesByVirtualHostName</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96fbc1b3945445f6978da558e3765f7c~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>发现一个名为<code>virtualHostNameAppMap</code>的Map集合中已经保存了当前所有注册到eureka的服务列表。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">VipIndexSupport</span><span class="token punctuation">&gt;</span></span> virtualHostNameAppMap<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>也就是说，在我们没有手动去调用服务的时候，该集合里面已经有值了，说明在Eureka-server项目启动后，会自动去拉取服务，并将拉取的服务缓存起来。</p><p>那么追根溯源，来查找一下服务的发现究竟是什么时候完成的。回到<code>DiscoveryClient</code>这个类，在它的构造方法中定义了任务调度线程池<code>cacheRefreshExecutor</code>，定义完成后，调用<code>initScheduledTask</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef4e409be85545ccbbab04e71708e681~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在这个thread中，调用了<code>refreshRegistry()</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2b414fc8444437aacec3eccb46bf87b~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在<code>fetchRegistry</code>方法中，执行真正的服务列表拉取：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/645d8498664744b6a37a38e2eca2a7dc~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在<code>fetchRegistry</code>方法中，先判断是进行增量拉取还是全量拉取：</p><p><strong>1、全量拉取</strong></p><p>当缓存为<code>null</code>，或里面的数据为空，或强制时，进行全量拉取，执行<code>getAndStoreFullRegistry</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bfd78860ceec46f5b94b4cfdd12a7f3b~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p><strong>2、增量拉取</strong></p><p>只拉取修改的，执行<code>getAndUpdateDelta</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e7fc06f2d594c478490160de3441ada~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>①②：先发送http请求，获取在eureka-server中修改或新增的集合</p><p>③：判断，若拉取的集合为null，则进行全量拉取</p><p>④：更新操作，在<code>updateDelta</code>方法中，根据类型进行更改</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a028a96c01df42e890870cf42a60965e~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>⑤：获取一致性的hashcode值，用来校验eureka-server集合和本地是否一样</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67d61204782543fab58a7e58353d071c~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在这进行判断，若远程集合的hash值等于缓存中的hash值，不需要拉取，否则再进行拉取一次。</p><p>最后提一下，<code>Applications</code>中定义的以下这些变量，都是在eureka-server中准备好的，直接拉取就可以了。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Application</span><span class="token punctuation">&gt;</span></span> applications<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Application</span><span class="token punctuation">&gt;</span></span> appNameApplicationMap<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">VipIndexSupport</span><span class="token punctuation">&gt;</span></span> virtualHostNameAppMap<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">VipIndexSupport</span><span class="token punctuation">&gt;</span></span> secureVirtualHostNameAppMap<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对服务发现过程进行一下重点总结：</p><ul><li>服务列表的拉取并不是在服务调用的时候才拉取，而是在项目启动的时候就有定时任务去拉取了，这点在<code>DiscoveryClient</code>的构造方法中能够体现；</li><li>服务的实例并不是实时的Eureka-server中的数据，而是一个本地缓存的数据；</li><li>缓存更新根据实际需求分为全量拉取与增量拉取。</li></ul><h2 id="集群信息同步" tabindex="-1"><a class="header-anchor" href="#集群信息同步" aria-hidden="true">#</a> 集群信息同步</h2><h3 id="eureka-server-4" tabindex="-1"><a class="header-anchor" href="#eureka-server-4" aria-hidden="true">#</a> Eureka-server</h3><p>集群信息同步发生在Eureka-server之间，之前提到在<code>PeerAwareInstanceRegistryImpl</code>类中，在执行<code>register</code>方法注册微服务实例完成后，执行了集群信息同步方法<code>replicateToPeers</code>，具体分析一下该方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1264f243021e4c34a38048532f60e69f~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>首先，遍历集群节点，用以给各个集群信息节点进行信息同步。</p><p>然后，调用<code>replicateInstanceActionsToPeers</code>方法，在该方法中根据具体的操作类型Action，选择分支，最终调用<code>PeerEurekaNode</code>的<code>register</code>方法：</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493db40c81854a7fa2694746905ebaf9~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>最终发送http请求，但是与普通注册操作不同的时，这时将集群同步的标识置为true，说明注册信息是来自集群同步。</p><figure><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67857c1af8604d98b22df5b5d597085d~tplv-k3u1fbpfcp-zoom-1.image" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>在注册过程中运行到<code>addInstance</code>方法时，单独注册时<code>isReplication</code>的值为false，集群同步时为true。通过该值，能够避免集群间出现死循环，进行循环同步的问题。</p><h2 id="最后" tabindex="-1"><a class="header-anchor" href="#最后" aria-hidden="true">#</a> 最后</h2><p>到这里，Eureka声明周期中比较重要的六个部分我们就讲完了。由于篇幅有限，只能讲一下大致的流程，如果还想再深入了解一些，不妨自己看看源码，毕竟，源码是最好的老师。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/trunks2008/edit/main/demo/theme-docs/src/springcloud/Eureka.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: jialegeyou1111@163.com">trunks2008</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><!----><a href="/springcloud/Ribbon.html" class="nav-link next" aria-label="Ribbon核心源码解析"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Ribbon核心源码解析<span class="font-icon icon iconfont icon-page" style=""></span></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">有趣、深入、直接，与你聊聊技术</div><div class="copyright">Copyright © 2023 Hydra</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-ef013678.js" defer></script>
  </body>
</html>
